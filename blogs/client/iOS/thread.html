<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>iOS多线程开发 | FeliksLv的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="记录学习过程，分享生活琐碎。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.9d8bef43.css" as="style"><link rel="preload" href="/assets/js/app.36d0a6ec.js" as="script"><link rel="preload" href="/assets/js/7.d2153018.js" as="script"><link rel="preload" href="/assets/js/2.a0c1b494.js" as="script"><link rel="preload" href="/assets/js/1.7fd99bae.js" as="script"><link rel="preload" href="/assets/js/80.38a4fcc8.js" as="script"><link rel="prefetch" href="/assets/js/10.4aa033e8.js"><link rel="prefetch" href="/assets/js/11.ca92390e.js"><link rel="prefetch" href="/assets/js/14.9702a0eb.js"><link rel="prefetch" href="/assets/js/15.0c98c468.js"><link rel="prefetch" href="/assets/js/16.16732acc.js"><link rel="prefetch" href="/assets/js/17.8978eff3.js"><link rel="prefetch" href="/assets/js/18.4c3efd91.js"><link rel="prefetch" href="/assets/js/19.547b4419.js"><link rel="prefetch" href="/assets/js/20.9985bf84.js"><link rel="prefetch" href="/assets/js/21.544a170a.js"><link rel="prefetch" href="/assets/js/22.6ee7f53e.js"><link rel="prefetch" href="/assets/js/23.a6c4d0fc.js"><link rel="prefetch" href="/assets/js/24.6dfd25a0.js"><link rel="prefetch" href="/assets/js/25.0fb5d5aa.js"><link rel="prefetch" href="/assets/js/26.462eeb79.js"><link rel="prefetch" href="/assets/js/27.5638f16c.js"><link rel="prefetch" href="/assets/js/28.e6801d53.js"><link rel="prefetch" href="/assets/js/29.f988f2e7.js"><link rel="prefetch" href="/assets/js/3.da28cb09.js"><link rel="prefetch" href="/assets/js/30.f11cbb73.js"><link rel="prefetch" href="/assets/js/31.cc2c86c7.js"><link rel="prefetch" href="/assets/js/32.07dce452.js"><link rel="prefetch" href="/assets/js/33.f9350f26.js"><link rel="prefetch" href="/assets/js/34.94b805b1.js"><link rel="prefetch" href="/assets/js/35.63eaeb2a.js"><link rel="prefetch" href="/assets/js/36.13c9aac7.js"><link rel="prefetch" href="/assets/js/37.3ab8e0e8.js"><link rel="prefetch" href="/assets/js/38.ac01c8ad.js"><link rel="prefetch" href="/assets/js/39.d45350dd.js"><link rel="prefetch" href="/assets/js/4.f75cc8bd.js"><link rel="prefetch" href="/assets/js/40.596c6f3c.js"><link rel="prefetch" href="/assets/js/41.a9f0d624.js"><link rel="prefetch" href="/assets/js/42.2acd1912.js"><link rel="prefetch" href="/assets/js/43.94409ad8.js"><link rel="prefetch" href="/assets/js/44.5989b9e4.js"><link rel="prefetch" href="/assets/js/45.c0f2f766.js"><link rel="prefetch" href="/assets/js/46.0ee79938.js"><link rel="prefetch" href="/assets/js/47.2bc37424.js"><link rel="prefetch" href="/assets/js/48.ba467c1a.js"><link rel="prefetch" href="/assets/js/49.3d4277f2.js"><link rel="prefetch" href="/assets/js/5.6cbc200d.js"><link rel="prefetch" href="/assets/js/50.20032635.js"><link rel="prefetch" href="/assets/js/51.2ff458c9.js"><link rel="prefetch" href="/assets/js/52.f65235b3.js"><link rel="prefetch" href="/assets/js/53.511001a5.js"><link rel="prefetch" href="/assets/js/54.5a54110d.js"><link rel="prefetch" href="/assets/js/55.eca851a2.js"><link rel="prefetch" href="/assets/js/56.76dadab3.js"><link rel="prefetch" href="/assets/js/57.475b0e6b.js"><link rel="prefetch" href="/assets/js/58.379be62e.js"><link rel="prefetch" href="/assets/js/59.497fc999.js"><link rel="prefetch" href="/assets/js/6.0157176f.js"><link rel="prefetch" href="/assets/js/60.38439091.js"><link rel="prefetch" href="/assets/js/61.fcabd0b8.js"><link rel="prefetch" href="/assets/js/62.e15c7782.js"><link rel="prefetch" href="/assets/js/63.0844bd92.js"><link rel="prefetch" href="/assets/js/64.739dfc0c.js"><link rel="prefetch" href="/assets/js/65.6ce9d827.js"><link rel="prefetch" href="/assets/js/66.16279015.js"><link rel="prefetch" href="/assets/js/67.05311991.js"><link rel="prefetch" href="/assets/js/68.ac09eb5e.js"><link rel="prefetch" href="/assets/js/69.54acfcde.js"><link rel="prefetch" href="/assets/js/70.b2b6ebaa.js"><link rel="prefetch" href="/assets/js/71.ead4c494.js"><link rel="prefetch" href="/assets/js/72.0baa9dfd.js"><link rel="prefetch" href="/assets/js/73.3883bd1a.js"><link rel="prefetch" href="/assets/js/74.0bbfaee7.js"><link rel="prefetch" href="/assets/js/75.4b05309e.js"><link rel="prefetch" href="/assets/js/76.a057f330.js"><link rel="prefetch" href="/assets/js/77.51314d49.js"><link rel="prefetch" href="/assets/js/78.72e746d7.js"><link rel="prefetch" href="/assets/js/79.c7b2373f.js"><link rel="prefetch" href="/assets/js/8.f4e25b0a.js"><link rel="prefetch" href="/assets/js/81.884264ed.js"><link rel="prefetch" href="/assets/js/82.eb7b93b5.js"><link rel="prefetch" href="/assets/js/83.94253816.js"><link rel="prefetch" href="/assets/js/84.e6377afc.js"><link rel="prefetch" href="/assets/js/85.6eaf784d.js"><link rel="prefetch" href="/assets/js/86.ad1d80de.js"><link rel="prefetch" href="/assets/js/87.fd107e61.js"><link rel="prefetch" href="/assets/js/88.7dad9bd2.js"><link rel="prefetch" href="/assets/js/89.9c55674c.js"><link rel="prefetch" href="/assets/js/9.091eb98d.js"><link rel="prefetch" href="/assets/js/90.cd0d7dea.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d8eaf4d6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9d8bef43.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>FeliksLv的博客</h3> <p class="description" data-v-59e6cb88>记录学习过程，分享生活琐碎。</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>FeliksLv</span>
          
        <span data-v-59e6cb88>2019 - </span>
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="FeliksLv的博客" class="logo"> <span class="site-name">FeliksLv的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/categories/公共基础/" class="nav-link"><i class="undefined"></i>
  公共基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/客户端/" class="nav-link"><i class="undefined"></i>
  客户端
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/others/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    FeliksLv
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>39</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>21</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/categories/公共基础/" class="nav-link"><i class="undefined"></i>
  公共基础
</a></li><li class="dropdown-item"><!----> <a href="/categories/客户端/" class="nav-link"><i class="undefined"></i>
  客户端
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/others/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>iOS多线程开发</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>FeliksLv</span>
          
        <span data-v-59e6cb88>2019 - </span>
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">iOS多线程开发</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>FeliksLv</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2022/4/14</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>OC</span><span class="tag-item" data-v-8a445198>iOS</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="同步和异步"><a href="#同步和异步" class="header-anchor">#</a> 同步和异步</h2> <p><strong>同步执行（sync）</strong>：</p> <ul><li>同步添加任务到指定的队列中，在添加的任务执行结束之前，会一直等待，直到队列里面的任务完成之后再继续执行。</li> <li>只能在当前线程中执行任务，不具备开启新线程的能力。</li></ul> <p><strong>异步执行（async）</strong>：</p> <ul><li>异步添加任务到指定的队列中，它不会做任何等待，可以继续执行任务。</li> <li>可以在新的线程中执行任务，具备开启新线程的能力。</li></ul> <h2 id="进程和线程"><a href="#进程和线程" class="header-anchor">#</a> 进程和线程</h2> <p>线程与进程的比较如下:</p> <ul><li><p>进程是资源(包括内存、打开的文件等)分配的单位，线程是 CPU 调度的单位;</p></li> <li><p>进程拥有一个完整的资源平台，而线程只独享必不可少的资源，如寄存器和栈;</p></li> <li><p>线程同样具有就绪、阻塞、执行三种基本状态，同样具有状态之间的转换关系;</p></li> <li><p>线程能减少并发执行的时间和空间开销;</p></li></ul> <p>对于，线程相比进程能减少开销，体现在:</p> <ul><li>线程的创建时间比进程快，因为进程在创建的过程中，还需要资源管理信息，比如内存管理信息、文件管理信息，而线程在创建的过程中，不会涉及这些资源管理信息，而是共享它们;</li> <li>线程的终止时间比进程快，因为线程释放的资源相比进程少很多;</li> <li>同一个进程内的线程切换比进程切换快，因为线程具有相同的地址空间(虚拟内存共享)，这意味着
同一个进程的线程都具有同一个⻚表，那么在切换的时候不需要切换⻚表。而对于进程之间的切换，
切换的时候要把⻚表给切换掉，而⻚表的切换过程开销是比较大的;</li> <li>由于同一进程的各线程间共享内存和文件资源，那么在线程之间数据传递的时候，就不需要经过内核了，这就使得线程之间的数据交互效率更高了;</li></ul> <p>所以，不管是时间效率，还是空间效率线程比进程都要高。</p> <h2 id="主线程"><a href="#主线程" class="header-anchor">#</a> 主线程</h2> <ul><li>一个程序运行后，默认会开启一个主线程，称为“主线程”或“UI 线程”。</li> <li>主线程一般用来刷新 UI 界面，处理 UI 事件（比如点击、滚动、拖拽</li> <li>别把耗时操作放到主线程，那样会卡住主线程，影响 UI 流畅度</li></ul> <h2 id="ios-多线程技术方案"><a href="#ios-多线程技术方案" class="header-anchor">#</a> iOS 多线程技术方案</h2> <table><thead><tr><th>技术方案</th> <th>简介</th> <th>语言</th> <th>线程生命周期</th> <th>使用频率</th></tr></thead> <tbody><tr><td>pthread</td> <td>一套通用的多线程 API，适用于 Linux/Uninx/Windows 等系统，跨平台、可移植，使用难度较大</td> <td>C</td> <td>程序员管理</td> <td>几乎不用</td></tr> <tr><td>NSThread</td> <td>使用更加面向对象，简单易用，直接操作线程对象</td> <td>OC</td> <td>程序员管理</td> <td>偶尔不用</td></tr> <tr><td>GCD</td> <td>旨在替代 NSThread 等多线程技术，充分利用设备的多核</td> <td>C</td> <td>自动管理</td> <td>经常使用</td></tr> <tr><td>NSOperation</td> <td>基于 GCD，比 GCD 多了一些更简单实用的功能，使用更加面向对象</td> <td>OC</td> <td>自动管理</td> <td>经常使用</td></tr></tbody></table> <h2 id="pthread"><a href="#pthread" class="header-anchor">#</a> pthread</h2> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread/pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hello %s\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 线程编号地址</span>
  <span class="token comment">// 2. 线程的属性</span>
  <span class="token comment">// 3. 线程要执行的函数</span>
  <span class="token comment">// 4. 要执行函数的参数</span>
  <span class="token comment">// 函数返回值 int 0成功 非0 失败</span>
  <span class="token class-name">pthread_t</span> pthread<span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token string">&quot;felikslv&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hello<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;失败\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="传递-oc-字符串"><a href="#传递-oc-字符串" class="header-anchor">#</a> 传递 oc 字符串</h3> <p>使用<code>__bridge</code>桥接</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>pthread_t pthread<span class="token punctuation">;</span>
NSString <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token string">@&quot;felikslv&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pthread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hello<span class="token punctuation">,</span> <span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  NSString <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token punctuation">(</span>__bridge NSString <span class="token operator">*</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>
  <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;Hello %@&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="nsthread"><a href="#nsthread" class="header-anchor">#</a> NSThread</h2> <p>方式一</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>NSThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span> initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span> <span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>方式二</p> <p>创建后立即执行</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token punctuation">[</span>NSThread detachNewThreadSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> toTarget<span class="token punctuation">:</span><span class="token keyword">self</span> withObject<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>方式三</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token punctuation">[</span><span class="token keyword">self</span> performSelectorInBackground<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> withObject<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>方式四 带参数</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>NSThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span> initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">:</span><span class="token punctuation">)</span> object<span class="token punctuation">:</span><span class="token string">@&quot;felikslv&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="nsthread-生命周期"><a href="#nsthread-生命周期" class="header-anchor">#</a> NSThread 生命周期</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 新建状态</span>
NSThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span> initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">:</span><span class="token punctuation">)</span> object<span class="token punctuation">:</span><span class="token string">@&quot;felikslv&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 就绪状态</span>
<span class="token punctuation">[</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo<span class="token punctuation">:</span> <span class="token punctuation">(</span>NSString<span class="token operator">*</span><span class="token punctuation">)</span>name <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;hello %@&quot;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 阻塞状态</span>
            <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 结束 线程执行完成之后会自动销毁</span>
            <span class="token punctuation">[</span>NSThread exit<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>其他方法</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>NSThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span> initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">:</span><span class="token punctuation">)</span> object<span class="token punctuation">:</span><span class="token string">@&quot;felikslv&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">@&quot;thread&quot;</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span>threadPriority <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span> <span class="token comment">// 取值返回 0 ～ 1， 默认是0.5</span>
<span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取当前线程</span>
<span class="token punctuation">[</span>NSThread isMainThread<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 判断当前是不是主线程</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>内核调度算法在决定该运行哪个线程时，会把线程的优先级作为考量因素，较高优先级的线程会比较低优先级的线程具有更多的运行机会。较高优先级不保证你的线程具体执行的时间，只是相比较低优先级的线程，它更有可能被调度器选择执行而已。</p> <h3 id="互斥锁"><a href="#互斥锁" class="header-anchor">#</a> 互斥锁</h3> <p>多线程操作共享资源的时候，会有很大概率出现非线程安全问题。可以通过使用互斥锁<code>@synchronized</code>来实现，能有效防止因多线程抢夺资源造成的数据安全问题。线程同步，多条线程按顺序执行任务。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>myMethod<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>anObj <span class="token punctuation">{</span>
    <span class="token operator">@</span><span class="token function">synchronized</span><span class="token punctuation">(</span>anObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在括号内 anObj 不会被其他线程改变</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>swift 中已经移除了<code>@synchronized</code>，可以通过以下代码来实现:</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">synchronized</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> lock<span class="token punctuation">:</span> <span class="token class-name">AnyObject</span><span class="token punctuation">,</span> closure<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">objc_sync_enter</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token punctuation">{</span> <span class="token function">objc_sync_exit</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="互斥锁原理"><a href="#互斥锁原理" class="header-anchor">#</a> 互斥锁原理</h4> <p>每一个对象(NSObject)内部都有一个锁（变量），当有线程进入 synchronized 到代码块中会先检查对象的锁是打开还是关闭状态，默认锁打开状态是 1，如果是线程执行到代码块内部会先上锁 0，如果锁被关闭，再有线程要执行代码块就先等待，直到锁打开才可以进入。</p> <p>线程执行到 synchronized：</p> <ol><li>检查锁状态，如果是开锁状态（1），转到 2，如果上锁（0）转到 5</li> <li>上锁（0）</li> <li>执行代码块</li> <li>执行完毕，开锁（1）</li> <li>线程等待（就绪状态）</li></ol> <p>加锁后程序执行的效率比不加锁的时候要低，因为要线程等待锁，但是锁保证了多个线程同时操作全局变量的安全性。</p> <h3 id="原子属性"><a href="#原子属性" class="header-anchor">#</a> 原子属性</h3> <p>属性中的修饰符</p> <ul><li>nonatomic 非原子属性，非线程安全</li> <li>atomic 原子属性(线程安全)，针对多线程设计，为默认值，需要消耗大量资源</li></ul> <p>atomic 保证同一时间只有一个线程能够写入，但是同一时间多个线程都可以取值。atomic 本身就有一把锁（自旋锁）。</p> <p>ios 开发建议：</p> <ul><li>所有属性都声明为 nonatmoic</li> <li>尽量避免多线程抢夺同一块资源</li> <li>尽量将加锁、资源抢夺的业务逻辑交给服务端解决，减小移动客户端的压力</li></ul> <h4 id="互斥锁和自旋锁的区别"><a href="#互斥锁和自旋锁的区别" class="header-anchor">#</a> 互斥锁和自旋锁的区别</h4> <p>互斥锁：</p> <ul><li>如果发现其他线程正在执行锁定代码，线程就会进入休眠（就绪状态），等其它线程事件片到打开锁后，线程就会被唤醒（执行）</li></ul> <p>自旋锁：</p> <ul><li>如果发现有其他线程正在锁定代码，线程会用死循环的方式，一直等待锁定的代码执行完成，自旋锁更适合执行不耗时的代码</li></ul> <h2 id="消息循环"><a href="#消息循环" class="header-anchor">#</a> 消息循环</h2> <ul><li>Runloop 就是消息循环，每一个线程内都有一个消息循环</li> <li>只有主线程的消息循环默认开启，子线程的消息循环默认不开启</li></ul> <p>消息循环的目的：</p> <ul><li>保证程序不退出</li> <li>负责处理输入事件</li> <li>如果没有事件发生，会让程序进入休眠状态</li></ul> <p>使用消息循环的时候必须指定两件事情：</p> <ul><li><p>输入事件：输入源/定时源</p></li> <li><p>消息循环模式</p></li></ul> <p>消息循环运行在某一种消息循环模式下，输入事件必须设置消息循环的模式，并且如果想让输入事件可以在消息循环上执行，输入事件的消息循环模式必须和当前消息循环的消息循环模式一致。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token keyword">@implementation</span> ViewController

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor systemBackgroundColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    UITextView <span class="token operator">*</span>textView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UITextView alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    textView<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">@&quot;...&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 设置成一个长文本，使得textview可以滚动</span>
    textView<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token punctuation">[</span>UIFont systemFontOfSize<span class="token punctuation">:</span><span class="token number">12.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    textView<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view addSubview<span class="token punctuation">:</span>textView<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSTimer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token punctuation">[</span>NSTimer timerWithTimeInterval<span class="token punctuation">:</span><span class="token number">1.0</span> target<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> userInfo<span class="token punctuation">:</span>nil repeats<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token comment">// 设置成Common模式</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span>addTimer<span class="token punctuation">:</span>timer forMode<span class="token punctuation">:</span> NSRunLoopCommonModes<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;hello %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span><span class="token punctuation">.</span>currentMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>如果这里将 runloop 的模式设置成<code>NSDefaultRunLoopMode</code>模式的话，在滚动 textview 的时候，不会输出任何信息，因为在滚动的时候，currentRunLoop 的模式为<code>UITrackingRunLoopMode</code>，与设置的模式不符。而<code>NSRunLoopCommonModes</code>模式包含了<code>NSDefaultRunLoopMode</code>和<code>NSDefaultRunLoopMode</code>。</p> <h3 id="子线程的消息循环"><a href="#子线程的消息循环" class="header-anchor">#</a> 子线程的消息循环</h3> <p>主线程的消息循环默认开启，子线程的消息循环默认不开启。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;I'm running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开启子线程的消息循环</span>
    <span class="token comment">// 如果消息循环里没有添加输入事件，消息循环会立刻退出</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span>run<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo1 <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;I'm running on runloop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

NSThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSThread alloc<span class="token punctuation">]</span>initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 往子线程添加输入源</span>
<span class="token punctuation">[</span><span class="token keyword">self</span> performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo1<span class="token punctuation">)</span> onThread<span class="token punctuation">:</span>thread withObject<span class="token punctuation">:</span>nil waitUntilDone<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="gcd"><a href="#gcd" class="header-anchor">#</a> GCD</h2> <p>全称 Grand Central Dispatch，使用 C 语言开发，提供了非常多的强大的函数。</p> <p>优势：</p> <ul><li>GCD 是苹果公司为多核的并行运算提出的解决方案</li> <li>GCD 会自动利用更多的 CPU 内核（比如双核、四核</li> <li>GCD 会自动管理线程的生命周期（创建线程、调度任务、销毁线程</li></ul> <h3 id="gcd-任务和队列"><a href="#gcd-任务和队列" class="header-anchor">#</a> GCD 任务和队列</h3> <h4 id="任务"><a href="#任务" class="header-anchor">#</a> 任务</h4> <p>任务就是执行操作的意思，换句话说就是你在线程中执行的那段代码。在 GCD 中是放在 block 中的。执行任务有两种方式：<strong>『同步执行』</strong> 和 <strong>『异步执行』</strong>。两者的主要区别是：<strong>是否等待队列的任务执行结束，以及是否具备开启新线程的能力。</strong></p> <ul><li>同步执行（sync）
<ul><li>同步添加任务到指定的队列中，在添加的任务执行结束之前，会一直等待，直到队列里面的任务完成之后再继续执行。</li> <li>只能在当前线程中执行任务，不具备开启新线程的能力。</li></ul></li> <li>异步执行（async）
<ul><li>异步添加任务到指定的队列中，它不会做任何等待，可以继续执行任务。</li> <li>可以在新的线程中执行任务，具备开启新线程的能力。</li></ul></li></ul> <h4 id="队列"><a href="#队列" class="header-anchor">#</a> 队列</h4> <p>这里的队列指执行任务的等待队列，即用来存放任务的队列。采用先进先出的原则。GCD 中有**『串行队列』** 和 **『并发队列』**两种队列。</p> <p><strong>串行队列（Serial Dispatch Queue）</strong>：</p> <ul><li>每次只有一个任务被执行。让任务一个接着一个地执行。（只开启一个线程，一个任务执行完毕后，再执行下一个任务）</li></ul> <p><strong>并发队列（Concurrent Dispatch Queue）</strong>：</p> <ul><li>可以让多个任务并发（同时）执行。（可以开启多个线程，并且同时执行任务）</li></ul> <blockquote><p>注意：<strong>并发队列</strong> 的并发功能只有在异步（dispatch_async）方法下才有效。</p></blockquote> <h3 id="gcd-的使用步骤"><a href="#gcd-的使用步骤" class="header-anchor">#</a> GCD 的使用步骤</h3> <ul><li>创建队列</li> <li>将任务添加到队列中</li></ul> <h4 id="创建队列"><a href="#创建队列" class="header-anchor">#</a> 创建队列</h4> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 串行队列的创建方法</span>
dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;net.bujige.testQueue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_SERIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 并发队列的创建方法</span>
dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;net.bujige.testQueue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_CONCURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Swift:</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// 串行队列</span>
<span class="token keyword">let</span> loaderQueue <span class="token operator">=</span> <span class="token class-name">DispatchQueue</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;com.felikslv.resourceLoader.queue&quot;</span></span><span class="token punctuation">)</span>
<span class="token comment">// 并行</span>
<span class="token keyword">let</span> loaderQueue <span class="token operator">=</span> <span class="token class-name">DispatchQueue</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;com.felikslv.resourceLoader.queue&quot;</span></span><span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token punctuation">.</span>concurrent<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>串行队列同步/异步执行</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 串行队列，同步执行，不开新线程, 任务按顺序执行</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;felikslv.queue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_SERIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch_sync</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---&gt; %d %@&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 串行队列，异步执行，开启新线程（1个），任务有序执行</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo1 <span class="token punctuation">{</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;felikslv.queue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_SERIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---&gt; %d %@&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>并行队列</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 并行队列，同步执行，不开新线程, 任务按顺序执行</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;felikslv.queue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_CONCURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch_sync</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---&gt; %d %@&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 并行队列，异步执行，开多个线程，任务无序执行</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo1 <span class="token punctuation">{</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;felikslv.queue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_CONCURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---&gt; %d %@&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="主队列"><a href="#主队列" class="header-anchor">#</a> 主队列</h4> <ul><li>对于串行队列，GCD 默认提供了：『主队列（Main Dispatch Queue）』
<ul><li>所有放在主队列中的任务，都会放到主线程中执行。</li> <li>可使用 <code>dispatch_get_main_queue()</code> 方法获得主队列。</li></ul></li></ul> <p>主队列异步执行时，没有开启新线程，任务按顺序执行。先执行完主线程上的任务，才会执行主队列中的任务</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---&gt; %d %@&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token comment">// 2022-04-19 17:44:13.421045+0800 geektime[44817:765851] start</span>
<span class="token comment">// 2022-04-19 17:44:13.421261+0800 geektime[44817:765851] end</span>
<span class="token comment">// 2022-04-19 17:44:13.479135+0800 geektime[44817:765851] ---&gt; 0 &lt;_NSMainThread: 0x6000031801c0&gt;{number = 1, name = main}</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>『主线程』</strong> 中调用 <strong>『主队列』+『同步执行』</strong> 会导致死锁问题。这是因为 <strong>主队列中追加的同步任务</strong> 和 <strong>主线程本身的任务</strong> 两者之间相互等待，阻塞了 <strong>『主队列』</strong>，最终造成了主队列所在的线程（主线程）死锁问题。可以放到子线程中，这样就不会发生死锁。代码如下：</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo1 <span class="token punctuation">{</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 添加任务在子线程上完成的</span>
            <span class="token function">dispatch_sync</span><span class="token punctuation">(</span><span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;---&gt; %d %@&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="全局并发队列"><a href="#全局并发队列" class="header-anchor">#</a> 全局并发队列</h4> <p>对于并发队列，GCD 默认提供了 <strong>『全局并发队列（Global Dispatch Queue）』</strong>。</p> <ul><li>可以使用 <code>dispatch_get_global_queue</code> 方法来获取全局并发队列。需要传入两个参数。第一个参数表示队列优先级，一般用 <code>DISPATCH_QUEUE_PRIORITY_DEFAULT</code>。第二个参数暂时没用，用 <code>0</code> 即可。</li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">// 全局并发队列的获取方法</span>
dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="barrier-阻塞"><a href="#barrier-阻塞" class="header-anchor">#</a> Barrier 阻塞</h3> <p>主要用于在多个异步操作完成之后，统一对非线程安全的对象进行更新</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 * 栅栏方法 dispatch_barrier_async
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>barrier <span class="token punctuation">{</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;net.bujige.testQueue&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_CONCURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 1</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 2</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_barrier_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 barrier</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;barrier---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 3</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 4</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="延迟操作"><a href="#延迟操作" class="header-anchor">#</a> 延迟操作</h3> <p><code>dispatch_after</code> 方法并不是在指定时间之后才开始执行处理，而是在指定时间之后将任务追加到主队列中。严格来说，这个时间并不是绝对准确的，但想要大致延迟执行任务，<code>dispatch_after</code> 方法是很有效的。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 * 延时执行方法 dispatch_after
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>after <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;currentThread---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印当前线程</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;asyncMain---begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_after</span><span class="token punctuation">(</span><span class="token function">dispatch_time</span><span class="token punctuation">(</span>DISPATCH_TIME_NOW<span class="token punctuation">,</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> NSEC_PER_SEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 2.0 秒后异步追加任务代码到主队列，并开始执行</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;after---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="一次性代码"><a href="#一次性代码" class="header-anchor">#</a> 一次性代码</h3> <p>使用 <code>dispatch_once</code> 方法能保证某段代码在程序运行过程中只被执行 1 次，并且即使在多线程的环境下，<code>dispatch_once</code> 也可以保证线程安全。常用于创建单例。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 * 一次性代码（只执行一次）dispatch_once
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>once <span class="token punctuation">{</span>
  <span class="token comment">// typedef long dispatch_once_t，默认是0</span>
    <span class="token keyword">static</span> dispatch_once_t onceToken<span class="token punctuation">;</span>
    <span class="token function">dispatch_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>onceToken<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 只执行 1 次的代码（这里面默认是线程安全的）</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>原理：判断静态全局变量的值，默认是 0，执行完成后，设置成-1，once 内部会判断，是 0 才会执行。</p> <p>可以使用<code>dispatch_once</code>来创建单例。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">+</span><span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>sharePerson<span class="token punctuation">{</span>
    <span class="token keyword">static</span> Person <span class="token operator">*</span>p <span class="token operator">=</span> nil <span class="token punctuation">;</span><span class="token comment">//1.声明一个空的静态的单例对象</span>
    <span class="token keyword">static</span> dispatch_once_t onceToken<span class="token punctuation">;</span> <span class="token comment">//2.声明一个静态的gcd的单次任务</span>
    <span class="token function">dispatch_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>onceToken<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span> <span class="token comment">//3.执行gcd单次任务：对对象进行初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            p <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>Person alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="快速迭代"><a href="#快速迭代" class="header-anchor">#</a> 快速迭代</h3> <ul><li>通常我们会用 for 循环遍历，但是 GCD 给我们提供了快速迭代的方法 <code>dispatch_apply</code>。<code>dispatch_apply</code> 按照指定的次数将指定的任务追加到指定的队列中，并等待全部队列执行结束。</li></ul> <p>如果是在串行队列中使用 <code>dispatch_apply</code>，那么就和 for 循环一样，按顺序同步执行。但是这样就体现不出快速迭代的意义了。</p> <p>我们可以利用并发队列进行异步执行。比如说遍历 0~5 这 6 个数字，for 循环的做法是每次取出一个元素，逐个遍历。<code>dispatch_apply</code> 可以 在多个线程中同时（异步）遍历多个数字。</p> <p>还有一点，无论是在串行队列，还是并发队列中，dispatch_apply 都会等待全部任务执行完毕，这点就像是同步操作，也像是队列组中的 <code>dispatch_group_wait</code>方法。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>apply <span class="token punctuation">{</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;apply---begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_apply</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">(</span>size_t index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%zd---%@&quot;</span><span class="token punctuation">,</span>index<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;apply---end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>因为是在并发队列中异步执行任务，所以各个任务的执行时间长短不定，最后结束顺序也不定。但是 <code>apply---end</code> 一定在最后执行。这是因为 <code>dispatch_apply</code> 方法会等待全部任务执行完毕。</p> <h3 id="调度组"><a href="#调度组" class="header-anchor">#</a> 调度组</h3> <p>有时候需要在多个异步任务都执行完成之后继续做某些事情，比如下载歌曲，等所有歌曲都下载完毕之后，转到主线程提醒用户。</p> <ul><li><p>调用队列组的 <code>dispatch_group_async</code> 先把任务放到队列中，然后将队列放入队列组中。或者使用队列组的 <code>dispatch_group_enter</code>、<code>dispatch_group_leave</code> 组合来实现 <code>dispatch_group_async</code>。</p></li> <li><p>调用队列组的 <code>dispatch_group_notify</code> 回到指定线程执行任务。或者使用 <code>dispatch_group_wait</code> 回到当前线程继续向下执行（会阻塞当前线程）。</p></li></ul> <h4 id="dispatch-group-notify"><a href="#dispatch-group-notify" class="header-anchor">#</a> dispatch_group_notify</h4> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 * 队列组 dispatch_group_notify
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>groupNotify <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;currentThread---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印当前线程</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;group---begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dispatch_group_t group <span class="token operator">=</span>  <span class="token function">dispatch_group_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_group_async</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 1</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_group_async</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 2</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_group_notify</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 等前面的异步任务 1、任务 2 都执行完毕后，回到主线程执行下边任务</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>

        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;group---end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>当所有任务都执行完成之后，才会执行<code>dispatch_group_notify</code>相关 block 中的任务。</p> <h4 id="dispatch-group-wait"><a href="#dispatch-group-wait" class="header-anchor">#</a> dispatch_group_wait</h4> <ul><li>暂停当前线程（阻塞当前线程），等待指定的 group 中的任务执行完成后，才会往下继续执行。</li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 * 队列组 dispatch_group_wait
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>groupWait <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;currentThread---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印当前线程</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;group---begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dispatch_group_t group <span class="token operator">=</span>  <span class="token function">dispatch_group_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_group_async</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 1</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dispatch_group_async</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 2</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待上面的任务全部完成后，会往下继续执行（会阻塞当前线程）</span>
    <span class="token function">dispatch_group_wait</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> DISPATCH_TIME_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;group---end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>从<code>dispatch_group_wait</code>相关代码运行输出结果可以看出：当所有任务执行完成之后，才执行 <code>dispatch_group_wait</code>之后的操作。但是，使用<code>dispatch_group_wait</code>会阻塞当前线程。</p> <h4 id="dispatch-group-enter、dispatch-group-leave"><a href="#dispatch-group-enter、dispatch-group-leave" class="header-anchor">#</a> dispatch_group_enter、dispatch_group_leave</h4> <ul><li><p><code>dispatch_group_enter</code> 标志着一个任务追加到 group，执行一次，相当于 group 中未执行完毕任务数 +1</p></li> <li><p><code>dispatch_group_leave</code> 标志着一个任务离开了 group，执行一次，相当于 group 中未执行完毕任务数 -1。</p></li> <li><p>当 group 中未执行完毕任务数为0的时候，才会使 <code>dispatch_group_wait</code> 解除阻塞，以及执行追加到 <code>dispatch_group_notify</code> 中的任务。</p></li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token comment">/**
 * 队列组 dispatch_group_enter、dispatch_group_leave
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>groupEnterAndLeave <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;currentThread---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印当前线程</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;group---begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    dispatch_group_t group <span class="token operator">=</span> <span class="token function">dispatch_group_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_group_enter</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 1</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>

        <span class="token function">dispatch_group_leave</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">dispatch_group_enter</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 追加任务 2</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
        
        <span class="token function">dispatch_group_leave</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">dispatch_group_notify</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 等前面的异步操作都执行完毕后，回到主线程.</span>
        <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">// 模拟耗时操作</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3---%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 打印当前线程</span>
    
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;group---end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>从 <code>dispatch_group_enter、dispatch_group_leave</code> 相关代码运行结果中可以看出：当所有任务执行完成之后，才执行 <code>dispatch_group_notify</code> 中的任务。这里的<code>dispatch_group_enter</code>、<code>dispatch_group_leave</code> 组合，其实等同于<code>dispatch_group_async</code>。</p> <h2 id="nsoperation"><a href="#nsoperation" class="header-anchor">#</a> NSOperation</h2> <ul><li>是OC语言基于GCD的面向对象的封装</li> <li>使用起来比GCD更加简单</li> <li>提供了一些GCD不好实现的功能</li> <li>苹果推荐使用，使用NSOperation不用关心线程以及线程的生命周期</li></ul> <p>NSOperation是一个抽象类，提供了NSInvocationOperation和NSBlockOperation两个子类。</p> <p>使用NSOperation和NSOperationQueue实现多线程的具体步骤：</p> <ol><li>先将需要执行的操作封装到一个NSOperation对象中。</li> <li>然后将NSOperation对象添加到NSOperationQueue中</li> <li>系统会自动将NSOperationQueue中的NSOperation取出来</li> <li>将取出的NSOperation封装的操作放到一条新线程中执行</li></ol> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span>NSSet<span class="token operator">&lt;</span>UITouch <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span>UIEvent <span class="token operator">*</span><span class="token punctuation">)</span>event <span class="token punctuation">{</span>
    NSInvocationOperation <span class="token operator">*</span>op <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSInvocationOperation alloc<span class="token punctuation">]</span>initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>isFinished<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// start方法更新操作的状态，调用main方法</span>
    <span class="token comment">// 不会开启新线程</span>
    <span class="token punctuation">[</span>op start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>添加队列的方式</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span>NSSet<span class="token operator">&lt;</span>UITouch <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span>UIEvent <span class="token operator">*</span><span class="token punctuation">)</span>event <span class="token punctuation">{</span>
    NSInvocationOperation <span class="token operator">*</span>op <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSInvocationOperation alloc<span class="token punctuation">]</span>initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span> object<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSOperationQueue <span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>queue addOperation<span class="token punctuation">:</span>op<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> demo <span class="token punctuation">{</span>
    <span class="token comment">// 2022-06-20 22:58:56.865857+0800 geektime[31610:2682704] &lt;NSThread: 0x60000047af40&gt;{number = 7, name = (null)}</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>NSOperation可以调用start方法来执行任务，但默认是同步执行的。如果将NSOperation添加到NSOperationQueue（操作队列）中，系统会自动异步执行NSOperation中的操作。</p> <h3 id="nsblockoperation"><a href="#nsblockoperation" class="header-anchor">#</a> NSBlockOperation</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>demo1 <span class="token punctuation">{</span>
    NSOperationQueue <span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSBlockOperation <span class="token operator">*</span>op <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;hello %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>queue addOperation<span class="token punctuation">:</span>op<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>也可以直接向队列中添加闭包</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>demo2 <span class="token punctuation">{</span>
    NSOperationQueue <span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>queue addOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;hello %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>也可以设置完成闭包<code>completionBlock</code>，或使用<code>addExecutionBlock</code>方法继续添加block到列表中。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>demo1 <span class="token punctuation">{</span>
    NSOperationQueue <span class="token operator">*</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSBlockOperation <span class="token operator">*</span>op <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;hello %@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>op addExecutionBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;task 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>op setCompletionBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>queue addOperation<span class="token punctuation">:</span>op<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="线程间通信"><a href="#线程间通信" class="header-anchor">#</a> 线程间通信</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue addOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;异步下载图片&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程间通信，回到主线程更新UI</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue mainQueue<span class="token punctuation">]</span>addOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@ 更新UI&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSOperationQueue currentQueue<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="最大并发数"><a href="#最大并发数" class="header-anchor">#</a> 最大并发数</h3> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token operator">-</span> <span class="token punctuation">(</span>NSOperationQueue<span class="token operator">*</span><span class="token punctuation">)</span> queue <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_queue <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大并发数</span>
        _queue<span class="token punctuation">.</span>maxConcurrentOperationCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="队列的暂停、取消、恢复"><a href="#队列的暂停、取消、恢复" class="header-anchor">#</a> 队列的暂停、取消、恢复</h3> <ul><li>取消队列的所有操作<code>cancelAllOperations</code>，也可以使用NSOperation的cancel方法取消单个操作。</li> <li>暂停和恢复，<code>setSuspended</code>和<code>isSuspended</code></li></ul> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">&quot;ViewController.h&quot;</span></span>

<span class="token keyword">@interface</span> <span class="token function">ViewController</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSOperationQueue <span class="token operator">*</span>queue<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> ViewController

<span class="token operator">-</span> <span class="token punctuation">(</span>NSOperationQueue<span class="token operator">*</span><span class="token punctuation">)</span> queue <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_queue <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue alloc<span class="token punctuation">]</span>init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大并发数</span>
        _queue<span class="token punctuation">.</span>maxConcurrentOperationCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Do any additional setup after loading the view.</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">@&quot;Home&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token punctuation">[</span>UIColor systemBackgroundColor<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>navigationController<span class="token punctuation">.</span>navigationBar setPrefersLargeTitles<span class="token punctuation">:</span>true<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> queue<span class="token punctuation">]</span>addOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
            <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>NSThread currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取消所有操作，当前正在执行的操作会执行完毕，取消后续的所有操作</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>IBAction<span class="token punctuation">)</span>cancel<span class="token punctuation">:</span><span class="token punctuation">(</span>UIButton <span class="token operator">*</span><span class="token punctuation">)</span>sender <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue cancelAllOperations<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;取消&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 暂停操作 当前正在执行的操作，会执行完毕，后续的操作会暂停</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>IBAction<span class="token punctuation">)</span>suspend<span class="token punctuation">:</span><span class="token punctuation">(</span>UIButton <span class="token operator">*</span><span class="token punctuation">)</span>sender <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>suspended <span class="token operator">=</span> YES<span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;暂停&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 继续操作</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>IBAction<span class="token punctuation">)</span>resume<span class="token punctuation">:</span><span class="token punctuation">(</span>UIButton <span class="token operator">*</span><span class="token punctuation">)</span>sender <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>suspended <span class="token operator">=</span> NO<span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;继续&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 当操作执行完毕，会从队列中移除</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span>NSSet<span class="token operator">&lt;</span>UITouch <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span>UIEvent <span class="token operator">*</span><span class="token punctuation">)</span>event <span class="token punctuation">{</span>
    <span class="token comment">// 队列中的操作数</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%zd&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>operationCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h3 id="操作的优先级"><a href="#操作的优先级" class="header-anchor">#</a> 操作的优先级</h3> <p>设置NSOperation在queue中的优先级，可以改变操作的执行优先级。</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>    NSBlockOperation <span class="token operator">*</span>op1 <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;op1 %d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置高优先级</span>
    op1<span class="token punctuation">.</span>qualityOfService <span class="token operator">=</span> NSQualityOfServiceUserInteractive<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue addOperation<span class="token punctuation">:</span>op1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    NSBlockOperation <span class="token operator">*</span>op2 <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;op2 %d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 低优先级</span>
    op2<span class="token punctuation">.</span>qualityOfService <span class="token operator">=</span> NSQualityOfServiceBackground<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue addOperation<span class="token punctuation">:</span>op2<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>先执行op1，再执行op2，只能保证op1执行的概率更大，但不能保证op1执行完再执行op2</p> <h3 id="操作依赖"><a href="#操作依赖" class="header-anchor">#</a> 操作依赖</h3> <p>NSOperation之间可以设置依赖来保证执行顺序，比如一定要让操作A执行完之后，才能执行操作B</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code><span class="token punctuation">[</span>operationB addDependency<span class="token punctuation">:</span>operationA<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 操作B依赖于A</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以在不同的queue的NSOperation之间创建依赖关系，可以用于模拟软件升级的过程：下载-解压-升级完成</p> <div class="language-objc line-numbers-mode"><pre class="language-objc"><code>    NSBlockOperation <span class="token operator">*</span>op1 <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;下载&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSBlockOperation <span class="token operator">*</span>op2 <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;解压&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSBlockOperation <span class="token operator">*</span>op3 <span class="token operator">=</span> <span class="token punctuation">[</span>NSBlockOperation blockOperationWithBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;升级完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>op2 addDependency<span class="token punctuation">:</span>op1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>op3 addDependency<span class="token punctuation">:</span>op2<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>queue addOperations<span class="token punctuation">:</span><span class="token operator">@</span><span class="token punctuation">[</span>op1<span class="token punctuation">,</span>op2<span class="token punctuation">]</span> waitUntilFinished<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 依赖关系可以跨队列执行</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span>NSOperationQueue mainQueue<span class="token punctuation">]</span>addOperation<span class="token punctuation">:</span>op3<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在使用依赖时要避免出现循环依赖的情况，此外，依赖关系是可以跨队列执行的。</p> <h3 id="gcd和nsoperation的区别"><a href="#gcd和nsoperation的区别" class="header-anchor">#</a> GCD和NSOperation的区别</h3> <ol><li><p>GCD是一种轻量级的方法来实现多线程。控制起来比较麻烦，比如取消和暂停一个线程。</p></li> <li><p>NSOperation和NSOperationQueue相对于GCD效率上要低一点，他们是面向对象的方式，从Mac OS X v10.6和iOS4开始，NSOperation底层也是用的GCD来实现的。可以在多个操作中添加附属，也可以重用操作，取消或者暂停。NSOperation和KVO是兼容，也就是说，可以在NSOperation中使用KVO，例如，你可以通过NSNotificationCenter去让一个操作开始执行。</p></li> <li><p>NSOperation的使用方法
【1】、继承NSOperation类
【2】、重写“main”方法
【3】、在“main”方法中创建一个autoreleasepool
【4】、将自己的代码放在autoreleasepool中
注意：创建自动释放池的原因是，你不能访问主线程的自动释放池，所以需要自己创建一个。</p></li> <li><p>NSOperation的常用方法</p> <ul><li>start：开始方法，当把NSOperation添加到NSOperationQueue中去后，队列会在操作中调用start方法。</li> <li>addDependency，removeDependency：添加从属性，删除从属性，比如说有线程a，b，如果操作a从属于b，那么a会等到b结束后才开始执行。</li> <li>setQueuePriority：设置线程的优先级。例：[a setQueuePriority:NSOperationQueuePriorityVeryLow];一共有四个优先级：NSOperationQueuePriorityLow，NSOperationQueuePriorityNormal，NSOperationQueuePriorityHigh，NSOperationQueuePriorityVeryHigh。
当你添加一个操作到一个队列时，在对操作调用start之前，NSOperationQueue会浏览所有的操作，具有较高优先级的操作会优先执行，具有相同优先级的操作会按照添加到队列中顺序执行。</li> <li>setCompletionBlock：设置回调方法，当操作结束后，会调用设置的回调block。这个block会在主线程中执行。</li></ul></li></ol> <p>什么时候使用GCD？什么时候使用NSOperation？</p> <p>项目中使用NSOperation的优点是NSOperation是对线程的高度抽象，在项目中使用它，会使项目的程序结构更好，子类化NSOperation的设计思路，是具有面向对象的优点(复用，封装)，使得实现是多线程支持，而接口简单，建议在复杂的项目中使用。</p> <p>项目中使用GCD的优点是GCD本身比NSOperation简单、易用，对于不复杂的多线程操作，会节省代码量，而Block参数的使用，会使代码更为易读，建议在简单的项目中使用</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2022/7/6 00:42:53</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#同步和异步" class="sidebar-link reco-side-同步和异步" data-v-b57cc07c>同步和异步</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#进程和线程" class="sidebar-link reco-side-进程和线程" data-v-b57cc07c>进程和线程</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#主线程" class="sidebar-link reco-side-主线程" data-v-b57cc07c>主线程</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#ios-多线程技术方案" class="sidebar-link reco-side-ios-多线程技术方案" data-v-b57cc07c>iOS 多线程技术方案</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#pthread" class="sidebar-link reco-side-pthread" data-v-b57cc07c>pthread</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#传递-oc-字符串" class="sidebar-link reco-side-传递-oc-字符串" data-v-b57cc07c>传递 oc 字符串</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#nsthread" class="sidebar-link reco-side-nsthread" data-v-b57cc07c>NSThread</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#nsthread-生命周期" class="sidebar-link reco-side-nsthread-生命周期" data-v-b57cc07c>NSThread 生命周期</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#互斥锁" class="sidebar-link reco-side-互斥锁" data-v-b57cc07c>互斥锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#原子属性" class="sidebar-link reco-side-原子属性" data-v-b57cc07c>原子属性</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#消息循环" class="sidebar-link reco-side-消息循环" data-v-b57cc07c>消息循环</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#子线程的消息循环" class="sidebar-link reco-side-子线程的消息循环" data-v-b57cc07c>子线程的消息循环</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#gcd" class="sidebar-link reco-side-gcd" data-v-b57cc07c>GCD</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#gcd-任务和队列" class="sidebar-link reco-side-gcd-任务和队列" data-v-b57cc07c>GCD 任务和队列</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#gcd-的使用步骤" class="sidebar-link reco-side-gcd-的使用步骤" data-v-b57cc07c>GCD 的使用步骤</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#barrier-阻塞" class="sidebar-link reco-side-barrier-阻塞" data-v-b57cc07c>Barrier 阻塞</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#延迟操作" class="sidebar-link reco-side-延迟操作" data-v-b57cc07c>延迟操作</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#一次性代码" class="sidebar-link reco-side-一次性代码" data-v-b57cc07c>一次性代码</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#快速迭代" class="sidebar-link reco-side-快速迭代" data-v-b57cc07c>快速迭代</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#调度组" class="sidebar-link reco-side-调度组" data-v-b57cc07c>调度组</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#nsoperation" class="sidebar-link reco-side-nsoperation" data-v-b57cc07c>NSOperation</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#nsblockoperation" class="sidebar-link reco-side-nsblockoperation" data-v-b57cc07c>NSBlockOperation</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#线程间通信" class="sidebar-link reco-side-线程间通信" data-v-b57cc07c>线程间通信</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#最大并发数" class="sidebar-link reco-side-最大并发数" data-v-b57cc07c>最大并发数</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#队列的暂停、取消、恢复" class="sidebar-link reco-side-队列的暂停、取消、恢复" data-v-b57cc07c>队列的暂停、取消、恢复</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#操作的优先级" class="sidebar-link reco-side-操作的优先级" data-v-b57cc07c>操作的优先级</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#操作依赖" class="sidebar-link reco-side-操作依赖" data-v-b57cc07c>操作依赖</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/client/iOS/thread.html#gcd和nsoperation的区别" class="sidebar-link reco-side-gcd和nsoperation的区别" data-v-b57cc07c>GCD和NSOperation的区别</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.36d0a6ec.js" defer></script><script src="/assets/js/7.d2153018.js" defer></script><script src="/assets/js/2.a0c1b494.js" defer></script><script src="/assets/js/1.7fd99bae.js" defer></script><script src="/assets/js/80.38a4fcc8.js" defer></script>
  </body>
</html>
